#### æ¦‚è¦
ã“ã®è¨˜äº‹ã§ã¯*Minikube*ã§å‹•ãå˜ä¸€ã®ã‚¯ãƒ©ã‚¹ã‚¿ä¸Šã«ã€Pythonè² è·æ¤œè¨¼ãƒ„ãƒ¼ãƒ«*Locust*ã‚’**è¤‡æ•°**æ§‹ç¯‰ã™ã‚‹ã€‚ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚µãƒ¼ãƒã«å¯¾ã—ã¦ã€è¤‡æ•°ã®Locustã‹ã‚‰**ä¸€æ–‰**ã«è² è·ã‚’ã‹ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã¾ã§ã®ç’°å¢ƒæ§‹ç¯‰æ‰‹é †ã‚’è¨˜ã™ã€‚

# å°å…¥ã¨èƒŒæ™¯ï¼ˆèª­ã¿é£›ã°ã—ã¦OKï¼‰
GKEä¸Šã«å­˜åœ¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®è² è·æ¤œè¨¼ã‚’Locustã§å®Ÿæ–½ã—ã¦ãŠã‚Šã¾ã—ãŸã€‚å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾ã—ã¦APIã‚’å®Ÿè¡Œã—ã¾ãã£ã¦ã€ãƒ‘ãƒ«ã‚¹çŠ¶ã®è² è·ã‚’ã‹ã‘ãŸæ™‚ã«ã€è¨­å®šé€šã‚Šã«podãŒå¢—åŠ ã—ã¦ãã‚Œã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ãŸã‹ã£ãŸã®ã§ã™ãŒã€ã©ã†ã‚„ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã®Locustã ã‘ã§ã¯ãã‚Œã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒ¦ãƒ¼ã‚¶æ•°ã‚’1000äººã«ã—ã¦ã‚‚ãƒ€ãƒ¡ï¼‰ã€‚

ã©ã†ã«ã‹APIã‚’ä½¿ç”¨ã—ã¦ãƒ‘ãƒ«ã‚¹çŠ¶ã®è² è·ã‚’ã‹ã‘ãŸãã¦èª¿æŸ»ã—ã¦ã„ã‚‹ã¨ã€Kubernatesã«podã‚’è¤‡æ•°ç”Ÿæˆã—ã¦ã€ãã®è¤‡æ•°podã‹ã‚‰Locustã§è² è·ã‚’ã‹ã‘ã‚‹æ–¹æ³•ãŒã‚ã‚‹ã“ã¨ã‚’çŸ¥ã‚Šã¾ã—ãŸã€‚ã—ã‹ã—ã€è‘—è€…ã¯Kubernateså¼±è€…ã§ã‚ã‚Šã€ã„ããªã‚Šé–‹ç™ºç’°å¢ƒã«ã‚ã‚Œã‚„ã“ã‚Œã‚„ã™ã‚‹ã®ã¯å›°é›£ã§ã‚ã‚‹ãŸã‚ã€ã¾ãšã¯Localã§æ‰±ãˆã‚‹Minikubeã§åŒç­‰ãªã“ã¨ãŒã§ãã‚‹ã‹ã‚’æ¤œè¨¼ã—ãŸã„ãªã€ã¨è€ƒãˆã‚ã‚Œã‚„ã“ã‚Œã‚„è©¦ã—ã¾ã—ãŸã€‚

ã“ã®è¨˜äº‹ã¯ä¸Šè¨˜ã®äº‹æƒ…ã‹ã‚‰æ›¸ã‹ã‚ŒãŸã‚‚ã®ã§ã‚ã‚Šã€ãã£ã¨ä¸å‚™ã‚„ä¸è¶³ã—ã¦ã„ã‚‹ç®‡æ‰€ãŒã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚ã‚‚ã—ãã®ã‚ˆã†ãªã‚‚ã®ã‚’è¦‹ã¤ã‘ãŸå ´åˆã«ã¯ã€ã¿ãªã•ã‚“ã®çŸ¥è­˜ãƒ»çŸ¥è¦‹ç­‰ã‚’ãœã²ã¨ã‚‚å…±æœ‰ã—ã¦ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ğŸ™‡

# æº–å‚™
## å‰ææ¡ä»¶
æ¬¡ãŒãƒ­ãƒ¼ã‚«ãƒ«ã®ç’°å¢ƒã«å‚™ã‚ã£ã¦ã„ã‚‹ã“ã¨ãŒå‰æã«ãªã‚‹ï¼š
- Docker
- kubectl
- Minikube
- Python3

## ã‚·ãƒ³ãƒ—ãƒ«ãªç´¹ä»‹

ä»Šå›ä½¿ç”¨ã™ã‚‹ä¸»è¦ãªã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦éå¸¸ã«ç°¡æ˜“çš„ã«ç´¹ä»‹ã™ã‚‹ã€‚

### Locust
Pythonã§æ›¸ã‹ã‚ŒãŸè² è·æ¤œè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚‹ã€‚

https://locust.io/

### Minikube
ç¾çŠ¶ã€ã‚³ãƒ³ãƒ†ãƒŠã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ã§ã‚ã‚‹*Kubernates*ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§æ§‹ç¯‰å¯èƒ½ã«ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã€‚

https://minikube.sigs.k8s.io/docs/

# æ§‹æˆ

## Podæ§‹æˆ
ãƒªã‚½ãƒ¼ã‚¹ã®é–¢ä¿‚ã¯ä¸‹è¨˜å›³ã§ã‚ã‚‹ã€‚ã“ã®å›³ã«ãŠã„ã¦ã€çŸ¢å°ã¯é€šä¿¡ã®èµ·ç‚¹ã‹ã‚‰æ¥ç¶šå…ˆã¸ã®åˆ°é”ã‚’ç¤ºã™ã‚‚ã®ã§ã‚ã‚Šã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€å—ä¿¡æ–¹å‘ã‚’å…¨ã¦è¡¨ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã€‚
![](https://storage.googleapis.com/zenn-user-upload/848f1e10ffe1-20250514.png)

è¤‡æ•°ã®worker-podï¼ˆå›³ã§ã¯2å€‹ï¼‰ãŒã‚µãƒ¼ãƒã¸è² è·ã‚’ã‹ã‘ã‚‹ãŸã‚ã«ã€APIã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ç¶šã‘ã‚‹ã€‚


## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
éå¸¸ã«å˜ç´”ãªæ§‹æˆã«ã—ã¦ã‚ã‚‹ã€‚
```
.
â”œâ”€â”€ Dockerfile.locust
â”œâ”€â”€ Dockerfile.server
â”œâ”€â”€ fastapi-deployment.yaml
â”œâ”€â”€ locust-master.yaml
â”œâ”€â”€ locust-worker.yaml
â”œâ”€â”€ locustfile.py
â””â”€â”€ server.py
```


# æ§‹ç¯‰æ‰‹é †

## Contextã‚’ç¢ºèªã™ã‚‹

Local PCã«ã‚ã‚‹Minikubeã§ãƒªã‚½ãƒ¼ã‚¹æ§‹ç¯‰ã‚’ç¢ºå®Ÿãªã‚‚ã®ã«ã™ã‚‹ãŸã‚ã«ã€ã¾ãšã¯contextã‚’ç¢ºèªã™ã‚‹ã€‚
ä¸‹è¨˜ã§contextã‚’ç¢ºèªã§ãã‚‹ï¼š
```
kubectl config current-context 
```
ã“ã®çµæœã€
```
minikube
```
ã¨è¡¨ç¤ºã•ã‚Œã‚Œã°å…ˆã«é€²ã‚ã‚‹ã€‚æœ¬ç•ªç’°å¢ƒã‚’èª¤ã£ã¦å¤‰æ›´ã—ãªã„ãŸã‚ã«ã‚‚ã€å¿…ãšç¢ºèªã•ã‚ŒãŸã„ã€‚

ã‚‚ã—ã€contextãŒminikubeã§ã¯ãªã„å ´åˆã€æ¬¡ã®è¨˜äº‹ã‚’å‚è€ƒã›ã‚ˆã€‚

https://www.skyarch.net/blog/kubernetes%E5%85%A5%E9%96%80-kubectl%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E5%85%88%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%82%92%E5%88%87%E3%82%8A%E6%9B%BF%E3%81%88/


## ã‚µãƒ¼ãƒã‚’podã«æ§‹ç¯‰

```python:server.py
from fastapi import FastAPI
from fastapi.responses import JSONResponse

app = FastAPI()

@app.get("/hello")
async def hello():
    return JSONResponse(content={"message": "Hello from FastAPI!"})
```

```Dockerfile:Dockerfile.server
# Dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY server.py .

RUN pip install fastapi uvicorn

CMD ["uvicorn", "server:app", "--host", "0.0.0.0", "--port", "8000"]
```

Minikube ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ­ãƒ¼ã‚«ãƒ« Docker ã‚’å‚ç…§ã—ãªã„ãŸã‚ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼š
```sh
eval $(minikube docker-env -u)
```
ãã®å¾Œã€
```sh
docker build -f Dockerfile.server -t fastapi-server:latest .
```

Minikubeã«podã‚’ä½œæˆã™ã‚‹ãŸã‚ã®YAMLã‚’ä¸ãˆã‚‹ï¼š
```yaml:fastapi-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fastapi
  template:
    metadata:
      labels:
        app: fastapi
    spec:
      containers:
        - name: fastapi
          image: fastapi-server:latest
          imagePullPolicy: Never
          ports:
            - containerPort: 8000
---
apiVersion: v1
kind: Service
metadata:
  name: fastapi-service
spec:
  selector:
    app: fastapi
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000
  type: ClusterIP
```

ãã—ã¦é©ç”¨ã™ã‚‹ï¼š

```sh
kubectl apply -f fastapi-deployment.yaml
```

ç¢ºèªã®ãŸã‚ã«`kube get pods`ã§podã®çŠ¶æ…‹ã‚’ç¢ºèªã§ãã‚‹ã€‚

## Locustã‚’podã«æ§‹ç¯‰

Locustã®Pythonãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
helloã¨ã„ã†APIã‚’å®Ÿè¡Œã™ã‚‹ã€‚
```python:locustfile.py
from locust import HttpUser, task, between

class SimpleUser(HttpUser):
    wait_time = between(1, 2)

    @task
    def hello(self):
        self.client.get("/hello")
```

Dockerfileã¯ä¸‹è¨˜ã§ã‚ã‚‹ã€‚
```Dockerfile:Dockerfile.locust
FROM locustio/locust

COPY locustfile.py /locustfile.py
```
ã‚µãƒ¼ãƒã®æ™‚ã¨åŒæ§˜ã«ã€Minikube VMå†…éƒ¨ã§`docker build`ã™ã‚‹ãŸã‚
```
eval $(minikube docker-env -u)
```
ã‚’å®Ÿè¡Œã—ã¦ã€
```
docker build -f Dockerfile.locust -t my-locust-image .
```
ã¨ã™ã‚‹ã€‚

æ¬¡ã«ã€master/workerç”¨ã®podã‚’ä½œæˆã™ã‚‹ã€‚podæ•°ã¯ãã‚Œãã‚Œæ¬¡ã®ã‚ˆã†ã«ã—ã¦ãŠãï¼š

- master-pod: 1å€‹
- worker-pod: 2å€‹

worker-podã®æ•°ã¯å¿…ãšã—ã‚‚2å€‹ã§ã‚ã‚‹å¿…è¦ã¯ãªã„ã“ã¨ã«ã¯ç•™æ„ã—ã¦ã»ã—ã„ã€‚Locustã§4ã¤ã®worker threadã‚’ç«‹ã¦ãŸã‘ã‚Œã°ä¸‹è¨˜ã§ç¤ºã™YAMLã®è©²å½“ç®‡æ‰€ã‚’4ã«ã™ã‚Œã°ã‚ˆã„ã€‚

ã¾ãšã€master-podç”¨ã®YAMLã¯
```yaml:locust-master.yaml
apiVersion: v1
kind: Service
metadata:
  name: locust-master
spec:
  selector:
    app: locust
    role: master
  ports:
    - protocol: TCP
      port: 8089
      targetPort: 8089
      name: http
    - protocol: TCP
      port: 5557
      targetPort: 5557
      name: locust-task
    - protocol: TCP
      port: 5558
      targetPort: 5558
      name: locust-health
  type: NodePort

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: locust-master
spec:
  replicas: 1
  selector:
    matchLabels:
      app: locust
      role: master
  template:
    metadata:
      labels:
        app: locust
        role: master
    spec:
      containers:
        - name: locust
          image: my-locust-image
          imagePullPolicy: Never
          args: ["-f", "/locustfile.py", "--master", "--host=http://fastapi-service:8000"]
          ports:
            - containerPort: 8089
            - containerPort: 5557
            - containerPort: 5558
```

ã§ã‚ã‚‹ã€‚ç¶šã„ã¦ã€workerç”¨ã®YAMLã¯

```yaml:locust-worker.yaml
# locust-worker.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: locust-worker
spec:
  replicas: 2
  selector:
    matchLabels:
      app: locust
      role: worker
  template:
    metadata:
      labels:
        app: locust
        role: worker
    spec:
      containers:
        - name: locust
          image: my-locust-image
          imagePullPolicy: Never
          args: ["-f", "/locustfile.py", "--worker", "--master-host=locust-master"]
```
ã§ã‚ã‚‹ã€‚ã“ã‚Œã‚‰2ã¤ã®YAMLã‚’Minikubeã«applyã™ã‚‹ï¼š
```sh
kubectl apply -f locust-master.yaml
kubectl apply -f locust-worker.yaml
```

--- 

ä»¥ä¸Šã‚’å®Ÿè¡Œã—ãŸä¸Šã§ã€ä¸€æ—¦podã®çŠ¶æ³ã‚’ç¢ºèªã™ã‚‹ã€‚
```
kubectl get pods
```
ã‚’å®Ÿè¡Œã—ã¦

![](https://storage.googleapis.com/zenn-user-upload/4a1f7e03b522-20250513.png)

ã®ã†ã‚ˆã†ãªè¡¨ç¤ºãŒç¾ã‚Œã‚Œã°ã‚ˆã„ã€‚æ³¨ç›®ã™ã‚‹ã¨ã“ã‚ã¯`STATUS`ã®æ¬„ã§ã€å…¨ã¦*Running*çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãŠãã€‚ã¾ãŸã€å¿µã®ãŸã‚ã«
```sh
kubectl get services
```
ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨

![](https://storage.googleapis.com/zenn-user-upload/5b68609a5c9e-20250513.png)

ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚

- fastapi-service: port 8000
- locust-master: port 8089, 5557, 5558

ãŒæˆ‘ã€…ãŒã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã—ã¦ã„ã‚‹éƒ¨åˆ†ã§ã‚ã‚‹ã®ã§ã€è¨­å®šã®é–“é•ã„ãŒãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
â€»ç”»åƒã®kubernatesã¯ç„¡è¦–ã—ã¦ã‚ˆã„ã€‚



æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§port 8089ã«å¯¾å¿œã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã™ã‚‹ã€‚
```sh
kubectl get svc locust-master -o json | jq '.spec.ports'
```
ã™ã‚‹ã¨
![](https://storage.googleapis.com/zenn-user-upload/60b17bcb9b12-20250513.png)
ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€port 8089ã«å¯¾å¿œã™ã‚‹URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€‚
â€»ç”»åƒä¾‹ã§ã¯[http://localhost:31642/](http://localhost:31642/)ã«ã‚¢ã‚¯ã‚»ã‚¹ã€‚

â€»jqã‚³ãƒãƒ³ãƒ‰ãŒç’°å¢ƒã«å­˜åœ¨ã—ãªã„å ´åˆã¯Homebrewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã‚ˆã„ã€‚Macã§ã¯
```
brew install jq
```

# çµæœ
ä¸Šè¨˜ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã€Locustã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ç”»åƒã®Workerã«ç€ç›®ã—ã¦ã»ã—ã„ã€‚ç¢ºã‹ã«ã€**WorkerãŒ2ã¨è¡¨ç¤º**ã•ã‚Œã¦ã„ã‚‹ã€‚
![](https://storage.googleapis.com/zenn-user-upload/9441a0f0b9c3-20250513.png)


ä¸‹è¨˜ç”»åƒã¯workerã®æ•°ã‚’4ã«ã—ãŸå ´åˆã®åˆ¥ã‚¿ãƒ–ç”»é¢ã§ã‚ã‚‹ã€‚APIã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ãƒ¦ãƒ¼ã‚¶æ•°ã‚’10ã¨è¨­å®šã—ã¦ã„ã‚‹ãŸã‚ã€ãã‚Œãã‚Œã®worker threadã«3, 3, 2, 2ã¨ãƒ¦ãƒ¼ã‚¶æ•°ãŒå‰²ã‚ŠæŒ¯ã‚‰ã‚Œã¦ã„ã‚‹ã€‚
![](https://storage.googleapis.com/zenn-user-upload/71829bca8081-20250513.png)

# ä»˜éŒ²

## ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã®æ–¹æ³•
æ§‹ç¯‰ã—ãŸpodã¯æ¬¡ã§å‰Šé™¤ã§ãã‚‹ï¼š

```sh
kubectl delete -f locust-master.yaml
kubectl delete -f locust-worker.yaml     
kubectl delete -f fastapi-deployment.yaml
```



# å‚è€ƒæ–‡çŒ®
https://hub.docker.com/r/locustio/locust

https://zeromq.org/

https://minikube.sigs.k8s.io/docs/start/?arch=%2Fmacos%2Farm64%2Fstable%2Fbinary+download

https://zenn.dev/ry/articles/97a5c50b1ddf16

https://zenn.dev/empenguin/articles/eda7535aeb0977

# æ›´æ–°å±¥æ­´
- 2025-05-14: jqã‚³ãƒãƒ³ãƒ‰ã«å¯¾ã™ã‚‹æ–‡è¨€ã‚’è¿½åŠ 